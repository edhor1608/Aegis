#!/usr/bin/env bash
set -euo pipefail

DRY_RUN=0
STAMP_FILE="$HOME/.config/senior-zero/onboarding.done"
HELP_FILE="/usr/share/senior-zero/help/welcome.txt"

if [[ "${1:-}" == "--dry-run" ]]; then
  DRY_RUN=1
elif [[ $# -gt 0 ]]; then
  echo "Usage: $0 [--dry-run]" >&2
  exit 2
fi

if [[ "$DRY_RUN" -eq 1 ]]; then
  printf '%s\n' "SENIOR_ZERO_ONBOARDING_DRY_RUN"
  printf 'STAMP_FILE=%s\n' "$STAMP_FILE"
  printf 'HELP_FILE=%s\n' "$HELP_FILE"
  exit 0
fi

if [[ -f "$STAMP_FILE" ]]; then
  printf '%s\n' "SENIOR_ZERO_ONBOARDING_ALREADY_DONE"
  exit 0
fi

mkdir -p "$(dirname "$STAMP_FILE")"
touch "$STAMP_FILE"

if [[ "${SENIOR_ZERO_ONBOARDING_NO_OPEN:-0}" != "1" ]] && command -v xdg-open >/dev/null 2>&1; then
  (xdg-open "$HELP_FILE" >/dev/null 2>&1 || true) &
fi

printf '%s\n' "SENIOR_ZERO_ONBOARDING_SHOWN"
