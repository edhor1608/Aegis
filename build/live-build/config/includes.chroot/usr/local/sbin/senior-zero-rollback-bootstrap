#!/usr/bin/env bash
set -euo pipefail

DRY_RUN=0

if [[ "${1:-}" == "--dry-run" ]]; then
  DRY_RUN=1
elif [[ $# -gt 0 ]]; then
  echo "Usage: $0 [--dry-run]" >&2
  exit 2
fi

STAMP_FILE="/var/lib/senior-zero/rollback-bootstrap.done"

if [[ "$DRY_RUN" -eq 1 ]]; then
  cat <<EOF
ROLLBACK_BOOTSTRAP_DRY_RUN
command -v snapper >/dev/null 2>&1
findmnt -n -o FSTYPE /
snapper list-configs | awk 'NR>1 {print \$2}' | grep -qx '/'
systemctl enable --now snapper-timeline.timer
systemctl enable --now snapper-cleanup.timer
touch $STAMP_FILE
EOF
  exit 0
fi

if [[ -f "$STAMP_FILE" ]]; then
  printf '%s\n' "ALREADY_DONE"
  exit 0
fi

if ! command -v snapper >/dev/null 2>&1; then
  printf '%s\n' "ERROR: snapper missing" >&2
  exit 1
fi

root_fs="$(findmnt -n -o FSTYPE /)"
if [[ "$root_fs" != "btrfs" ]]; then
  printf '%s\n' "NOT_APPLICABLE: rollback bootstrap requires installed btrfs root"
  exit 0
fi

if ! snapper list-configs | awk 'NR>1 {print $2}' | grep -qx '/'; then
  snapper create-config /
fi

systemctl enable --now snapper-timeline.timer
systemctl enable --now snapper-cleanup.timer

mkdir -p "$(dirname "$STAMP_FILE")"
touch "$STAMP_FILE"

printf '%s\n' "BOOTSTRAP_PASS"
