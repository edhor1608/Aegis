#!/usr/bin/env bash
set -euo pipefail

DRY_RUN=0

if [[ "${1:-}" == "--dry-run" ]]; then
  DRY_RUN=1
elif [[ $# -gt 0 ]]; then
  echo "Usage: $0 [--dry-run]" >&2
  exit 2
fi

UA_FILE="/etc/apt/apt.conf.d/52unattended-upgrades-senior-zero"
PIN_FILE="/etc/apt/preferences.d/90-senior-zero-security.pref"

CHECKS=(
  "systemctl is-enabled unattended-upgrades | grep -qx 'enabled'"
  "test -f ${UA_FILE}"
  "test -f ${PIN_FILE}"
  "grep -q 'Allowed-Origins' ${UA_FILE}"
  "grep -q 'security' ${UA_FILE}"
  "grep -q 'Pin-Priority: 990' ${PIN_FILE}"
  "grep -q 'Pin-Priority: 500' ${PIN_FILE}"
)

if [[ "$DRY_RUN" -eq 1 ]]; then
  printf '%s\n' "SECURITY_AUDIT_DRY_RUN"
  printf '%s\n' "${CHECKS[@]}"
  exit 0
fi

for check_cmd in "${CHECKS[@]}"; do
  if bash -lc "$check_cmd"; then
    printf 'PASS: %s\n' "$check_cmd"
  else
    printf 'FAIL: %s\n' "$check_cmd" >&2
    exit 1
  fi
done

if grep -q 'Automatic-Reboot "false"' "$UA_FILE"; then
  printf '%s\n' "PASS: automatic reboot stays disabled"
else
  printf '%s\n' "FAIL: automatic reboot policy mismatch" >&2
  exit 1
fi

printf '%s\n' "SECURITY_AUDIT_PASS"
